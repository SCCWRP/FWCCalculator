
# Flow-Weighting and Event Mean Concentration Calculation

<!-- badges: start -->
<!-- badges: end -->

### Purpose

This web application has been developed to enable consistent, transparent, easily applied calculations for post-storm flow-weighting and compositing and/or to generate an Event Mean Concentration (EMC) from a pollutograph. The web app provides flow-weighted compositing instructions based on a user-uploaded hydrograph and times of sample collection, or returns an EMC based on a user-uploaded hydrograph and pollutograph. Total hydrograph volume is also returned so that users may determine a mass load from the EMC.

### Background

The “gold standard” of stormwater control measure (SCM) performance monitoring is to collect and analyze water quality data as flow-weighted event mean concentrations (EMCs). EMCs may be generated by post-storm compositing of discrete samples as an alternative to collecting flow-weighted composite samples using automated equipment with integrated flow meters. Coincidentally, a standard procedure is not documented in industry-relevant literature to perform the requisite post-storm flow-weighting calculations. Lack of a documented procedure may deter data collection for agencies new to monitoring, or for complicated site conditions. It also leads to different approaches to post-storm flow-weighting that may influence resultant EMCs and mass loads.

The EMC parameter, fundamentally a pollutant concentration, is the ratio of the mass of pollutant to the volume of water flowing through the system in a given storm event.  Storm water volume is calculated as the integral of the hydrograph with time.  Total pollutant mass is obtained through the time integral of the product of the pollutograph (concentration with respect to time) and hydrograph functions.  The ratio of these integrals is given as the continuous definition of the EMC, 

$$\text{EMC} = \frac{M}{V} = \frac{\int_{0}^{t} C_t Q_t dt}{\int_{0}^{t} Q_t dt}$$

<div align="right"> 
Equation 1
</div>
  

Pollutant mass, $M$, is equal to the integral of instantaneous concentration, $C_t$, multiplied by flow, $Q_t$, while total volume, $V$, is the time integral of flow. The application returns the total volume calculated by the integral of the hydrograph with time; the user can multiply the EMC by the total storm volume to yield mass loading. 

### Method

The practical problem of solving for an EMC using real world data is evaluating the integrals in Equation 1 using discrete data points. Commonly, the continuous definition of EMC is recast in a discrete form, written as

$$ \text{EMC} = \frac{\int_{0}^{t} C_t Q_t dt}{\int_{0}^{t} Q_t dt} \approx \frac{\sum_{i=0}^{k} C_{i} V_{i}}{{\sum_{i=0}^{k} V_{i}}} $$

<div align="right"> 
Equation 2
</div>
  

where $k$ is the number of pollutograph samples taken, $C_i$ is the concentration of the $i^{th}$ water quality sample taken, and $V_i$ is the flow volume that can be attributed to sample $C_i$. Equation 2 effectively represents the EMC as a volume-weighted average concentration, wherein the volume weights are computed as the area under the hydrograph curve that is attributable to a given pollutograph value. In this application, the area under the hydrograph curve (i.e., the volume weight) is computed using a trapezoidal approximation. An additional hurdle imposed by the discrete sample data is to determine what portion of the hydrograph data to use as a volume weight.  This application uses a central attribution scheme, wherein a hydrograph segment is attributed to the nearest sample in time.  Taken together, the trapezoidal approximation and central attribution schemes yield a volume weight, $V_i$, for sample $i$ written as

$$ V_i = \frac{1}{2} \sum_{i-\frac{1}{2}}^{i+\frac{1}{2}} ( Q_{t+1} + Q_{t-1} ) \Delta t $$
<div align="right"> 
Equation 3
</div>
  
where $i \pm \frac{1}{2}$ corresponds to the time, $t_{i \pm \frac{1}{2}}$, halfway between when sample $i$ and samples $i \pm 1$ were taken. The time interval, $\Delta t$, is the interval between successive hydrograph values, $Q_t$.


### Supplemental Documentation

The application is currently hosted at https://sccwrp.shinyapps.io/FWC_EMC_Calculator/, with code available under an MIT license at https://github.com/SCCWRP/FWCCalculator/. 

A python version of the flow-weighting calculator from hydrograph and sample data was developed for a BMP monitoring project with the California Department of Transportation. The python script and supplemental data are available at https://github.com/SCCWRP/EMC_calculator_from_depth.

The application was subject to a Data Product Quality Assurance review process per SCCWRP policy; documentation of which can be found at https://github.com/SCCWRP/FWCCalculator/QA_Documents/.

There is an open question regarding the effect of integration approximation, sample-flow attribution schemes, and data resolution on the overall outcome of the EMC.  A sensitivity analysis comparing various solution schemes for the EMC is being compiled as part of a Technical Report in preparation.
